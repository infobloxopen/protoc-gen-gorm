syntax = "proto3";

package example;
import "github.com/infobloxopen/protoc-gen-gorm/options/gorm.proto";
import "github.com/infobloxopen/protoc-gen-gorm/types/types.proto";
import "google/protobuf/wrappers.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/infobloxopen/protoc-gen-gorm/example/feature_demo;example";

// test_types is a message that includes a representative sample of the
// available types
message TestTypes {
  // The 'ormable' option flags this for converter autogeneration
  // The table option allows for overriding the default table name 'test_types'
  option (gorm.opts) = {ormable:true, table: "smorgasbord"};
  // the (gorm.field).drop option allows for setting a field to be API only
  string api_only_string = 1 [(gorm.field).drop = true];
  // repeated raw types are currently unsupported, so this field will be dropped
  // at the ORM level
  repeated int32 numbers = 2;
  // a StringValue represents a Nullable string
  google.protobuf.StringValue optional_string = 3;
  // enums are mapped to the their underlying numeric value in the db.
  // This is practical from an API perspective, but tougher for debugging.
  // Strings with validation constraints can be used instead if desired
  enum status{
    UNKNOWN = 0;
    GOOD = 1;
    BAD = 2;
  }
  status becomes_int = 4;
  // The Empty type serves no purpose outside of rpc calls and is dropped
  // automatically from objects
  google.protobuf.Empty nothingness = 5;
  // The UUIDValue custom type should act like a string at the API level, but is
  // automatically converted to and from a uuid.UUID (github.com/satori/go.uuid)
  gorm.types.UUIDValue uuid = 6;
  // Timestamps convert to golang's time.Time type, and created_at and
  // updated_at values are automatically filled by GORM
  google.protobuf.Timestamp created_at = 7;
  // This represents a foreign key to the 'type_with_id' type for associations
  // This could be hidden from the API (or soon autogenerated).
  uint32 type_with_id_id = 8;
  // This is an arbitrary JSON string that is marshalled and unmarshalled
  // specially in grpc-gateway as a JSON object
  gorm.types.JSONValue json_field = 9;
}

// TypeWithID demonstrates some basic assocation behavior
message TypeWithID {
  // Again we use the 'ormable' option, but also include an extra field
  // using the 'include' option. Any number of fields can be defined this way
  // to be visible on the ORM side, but hidden from the API. This is generally
  // useful to aggregate values from the database into API fields
  option (gorm.opts) = {
    ormable: true,
    include: [
      {type: "int32", name: "secret_int", tag: {ignore: true}}
      ]
    };
  // any field named 'id' is assumed by gorm to be the primary key for the
  // object.
  uint32 id = 1;
  // The field option also allows arbitrary tag setting, such as informing
  // gorm of a primary key, different column names or different types in the db
  string ip = 2 [(gorm.field) = {tag: {column: "ip_addr"}}];
  // A default has-many relationship, will error on generation if no FK field,
  // convention {typename}_id, is present. These FK fields will be automatically
  // populated on create and update.
  repeated TestTypes things = 3;
  // A default has-one relationship, will error as above
  TestTypes a_nested_object = 4;
}

// MultiaccountTypeWithID demonstrates the generated multi-account support
message MultiaccountTypeWithID {
  // here we use the multi_account option to generate auth integration in
  // the ORM layer, and an assumed "account_id" column
  option (gorm.opts) = {
    ormable: true,
    multi_account: true
  };
  uint64 id = 1;
  string some_field = 2;
}

message MultiaccountTypeWithoutID {
  // here no id field is given, but it is still a multitenant type
  // this is a bad pattern, as there is no way to uniquely identify objects
  // in the DB, so R/U/D behavior is not well defined
  option (gorm.opts) = {
    ormable: true,
    multi_account: true
  };
  string some_field = 1;
}

message APIOnlyType {
  // here the ormable flag is not used, so nothing will be generated for this
  // object at the ORM level, and when this type is used as a field or
  // repeated field in another message that field will be dropped in the Orm
  // model, and would have to be set by hook
  string contents = 1;
}
